<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de Bord</title>

  <!-- Lien vers la feuille de style externe -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Favicon du site -->
  <link rel="icon" href="{{ url_for('static', filename='ressources/logo-serre.png') }}" type="image/png">

  <!-- Bibliothèque MQTT client pour gérer les messages MQTT côté client -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <!-- En-tête avec titre et barre de navigation -->
  <header>
    <div><strong>Serre Connectée</strong></div>
    <nav>
      <!-- Liens vers les différentes pages, avec mise en surbrillance du lien actif -->
      <a href="{{ url_for('home') }}" class="active">Accueil</a>
      <a href="{{ url_for('meteo') }}">Météo</a>
      <a href="{{ url_for('historique') }}">Historique</a>
    </nav>
  </header>

  <!-- Section carte modifiable (placeholder ici) -->
  <div class="section">
    <h2>Carte modifiable de la serre</h2>
    <div class="map-placeholder">(Ici 1)</div>
  </div>

  <!-- Affichage des indicateurs des capteurs -->
  <div class="container">
    <!-- Données capteurs intérieurs -->
    <div class="section indicators">
      <h3>Intérieur</h3>
      <div class="indicator temp">Température <p id="temperature-int"></p></div>
      <div class="indicator co2">CO₂ <p id="co2-int"></p></div>
      <div class="indicator hum">Humidité <p id="humidity-int"></p></div>
    </div>

    <!-- Données capteurs extérieurs -->
    <div class="section indicators">
      <h3>Extérieur</h3>
      <div class="indicator temp">Température <p id="temperature-ext"></p></div>
      <div class="indicator hum">Humidité <p id="humidity-ext"></p></div>
    </div>
  </div>

  <!-- Section prévisions météo ou conseils IA -->
  <div class="section">
    <h3>Prévisions (conseils IA)</h3>
    <textarea rows="4"></textarea>
  </div>

  <!-- Section commandes manuelles (actions) -->
  <div class="section">
    <div class="actions-header">
      <h3>Actions</h3>

      <!-- Sélecteur de capteur ciblé -->
      <div>
        <label for="sensor-select" class="action-label">Capteur :</label>
        <select id="sensor-select">
          <option value="">Sélectionner</option>
          <option value="interieur">Capteur Intérieur</option>
          <option value="exterieur">Capteur Extérieur</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <!-- Groupe commande chauffage -->
      <div class="action-group">
        <label class="action-label">Commande de chauffage :</label>
        <!-- Bouton avec classe et texte dynamique selon état du chauffage -->
        <button id="btn-chauffage" class="{{ 'chauffage-on' if etat_chauffage else 'chauffage-off' }}">
          {{ btn_text }}
        </button>
        <!-- Affichage température intérieure actuelle -->
        <p>Température : {{ data.interieur.temperature }} °C</p>
      </div>

      <!-- Groupe commande ventilation -->
      <div class="action-group">
        <label class="action-label">Modifier la ventilation :</label>
        <button id="btn-ouvrir" class="vent-btn">Ouvrir</button>
        <button id="btn-fermer" class="vent-btn">Fermer</button>
      </div>

      <!-- Groupe commande arrosage -->
      <div class="action-group">
        <label class="action-label" for="arrosage_duree">Commande d’arrosage :</label>
        <input type="number" id="arrosage_duree" placeholder="Durée (min)" min="1" max="60">
        <button id="btn-arroser">Lancer</button>
      </div>

      <!-- Groupe commande éclairage -->
      <div class="action-group">
        <label class="action-label" for="eclairage_duree">Commande d’éclairage :</label>
        <input type="number" id="eclairage_duree" placeholder="Durée (min)" min="1" max="60">
        <button id="btn-eclairer">Allumer</button>
      </div>

      <!-- Espace réservé pour futures options avancées -->
      <div class="other-options">
        <span class="small-text">Autres options</span>
      </div>
    </div>
  </div>

  <!-- Script JavaScript pour gérer les interactions utilisateur -->
  <script>
    /**
     * Fonction qui vérifie qu'un capteur est sélectionné avant d'exécuter une action
     * @returns {boolean} true si capteur sélectionné, false sinon
     */
    function capteurSelectionne() {
      const capteur = document.getElementById("sensor-select").value;
      if (capteur === "") {
        alert("Veuillez sélectionner un capteur avant de procéder.");
        return false;
      }
      return true;
    }

    // Récupération des boutons et champs du DOM pour interaction
    const btnOuvrir = document.getElementById("btn-ouvrir");
    const btnFermer = document.getElementById("btn-fermer");

    const arroserBtn = document.getElementById("btn-arroser");
    const arrosageInput = document.getElementById("arrosage_duree");

    const eclairerBtn = document.getElementById("btn-eclairer");
    const eclairageInput = document.getElementById("eclairage_duree");

    const btnChauffage = document.getElementById("btn-chauffage");

    // === Gestion du bouton Chauffage ===
    btnChauffage.addEventListener("click", () => {
      // Vérifier qu'un capteur est sélectionné
      if (!capteurSelectionne()) return;

      console.log("Chauffage : toggler");

      // Envoi d'une requête au serveur Flask pour changer l'état du chauffage
      fetch('/toggle_chauffage')
        .then(response => {
          if (response.ok) {
            console.log("Chauffage toggled");

            // Mise à jour dynamique du texte et de la couleur du bouton sans rechargement
            if (btnChauffage.textContent.includes("Allumer")) {
              btnChauffage.textContent = "Éteindre le chauffage";
              btnChauffage.style.backgroundColor = "rgb(98, 158, 238)";  // couleur bleu
            } else {
              btnChauffage.textContent = "Allumer le chauffage";
              btnChauffage.style.backgroundColor = "rgb(250, 88, 43)";   // couleur orange
            }
          } else {
            alert("Erreur lors de la commande chauffage.");
          }
        })
        .catch(err => {
          alert("Erreur réseau : " + err);
        });
    });

    // === Gestion du bouton Ventilation Ouvrir ===
    btnOuvrir.addEventListener("click", () => {
      if (!capteurSelectionne()) return;

      // Mise à jour des classes pour refléter l'état d'ouverture de la ventilation
      btnOuvrir.classList.add("ouvert");
      btnFermer.classList.remove("ferme", "ouvert");
      btnOuvrir.classList.remove("ferme");

      console.log("Ventilation : ouvrir");
    });

    // === Gestion du bouton Ventilation Fermer ===
    btnFermer.addEventListener("click", () => {
      if (!capteurSelectionne()) return;

      // Mise à jour des classes pour refléter l'état de fermeture de la ventilation
      btnFermer.classList.add("ferme");
      btnOuvrir.classList.remove("ouvert", "ferme");
      btnFermer.classList.remove("ouvert");

      console.log("Ventilation : fermer");
    });

    // === Gestion du bouton Arrosage ===
    arroserBtn.addEventListener("click", () => {
      if (!capteurSelectionne()) return;

      const minutes = parseInt(arrosageInput.value);
      // Vérifier que la durée est un nombre valide et positif
      if (!isNaN(minutes) && minutes > 0) {
        console.log(`Arrosage lancé pour ${minutes} minutes`);
      } else {
        alert("Merci d’entrer une durée valide pour l’arrosage.");
      }
    });

    // === Gestion du bouton Éclairage ===
    eclairerBtn.addEventListener("click", () => {
      if (!capteurSelectionne()) return;

      const minutes = parseInt(eclairageInput.value);
      // Vérifier que la durée est un nombre valide et positif
      if (!isNaN(minutes) && minutes > 0) {
        console.log(`Éclairage lancé pour ${minutes} minutes`);
      } else {
        alert("Merci d’entrer une durée valide pour l’éclairage.");
      }
    });

    // === Rechargement de la page lors du changement de sélection du capteur ===
    document.getElementById('sensor-select').addEventListener('change', function() {
      // Recharge la page entière pour appliquer les modifications liées au capteur sélectionné
      location.reload();
    });

  </script>

  <!-- Scripts externes pour fonctionnalités MQTT, envoi et récupération de données -->
  <script src="{{ url_for('static', filename='js/envoyerDonnees.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/connexionMQTT.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/recupererDonnees.js') }}" defer></script>
</body>
</html>
